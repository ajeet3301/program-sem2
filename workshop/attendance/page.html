<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Class Attendance</title>
  <style>
    body {
      margin: 0; padding: 0;
      background: #121212 no-repeat center center fixed;
      background-size: cover;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      min-height: 100vh; display: flex; flex-direction: column;
      justify-content: center; align-items: center; color: white;
    }
    .card {
      width: 85%; max-width: 380px;
      padding: 25px; border-radius: 20px;
      background: rgba(0, 0, 0, 0.75);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.1);
      text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    h2 { color: #00d2ff; margin-top: 0; letter-spacing: 1px; }
    select {
      width: 100%; padding: 12px; margin-bottom: 15px;
      background: #1a1a1a; border: 1px solid #444;
      border-radius: 10px; color: #fff; font-size: 15px; outline: none;
    }
    .btn-main {
      width: 100%; padding: 13px; border-radius: 10px;
      border: none; background: linear-gradient(135deg, #00d2ff, #3a7bd5);
      color: white; font-weight: bold; font-size: 16px; cursor: pointer;
      transition: 0.3s;
    }
    .btn-main:active { transform: scale(0.98); }
    
    .live-list { margin-top: 20px; text-align: left; border-top: 1px solid #333; padding-top: 15px; }
    #present-names { max-height: 150px; overflow-y: auto; font-size: 13px; color: #ccc; }
    .p-item { padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

    /* Suspicious Section */
    .btn-sus { 
        width: 100%; margin-top: 15px;
        background: rgba(255, 68, 68, 0.2); border: 1px solid #ff4444; 
        color: #ff4444; padding: 10px; border-radius: 8px; font-size: 14px; 
        cursor: pointer; font-weight: bold;
    }
    #sus-container { display: none; margin-top: 10px; border: 1px solid #ff4444; border-radius: 10px; padding: 10px; background: rgba(50,0,0,0.5); }
    #sus-list { color: #ff8888; font-size: 12px; text-align: left; max-height: 100px; overflow-y: auto; }
    
    /* Small Wallpaper Button */
    .wall-btn {
        background: none; border: none; color: #666; 
        font-size: 11px; margin-top: 10px; cursor: pointer; text-decoration: underline;
    }
    #bgInput { display: none; }

    .dev-container { margin-top: 20px; font-size: 11px; color: #555; border-top: 1px solid #222; padding-top: 10px;}
    .dev-btn { cursor: pointer; text-decoration: none; display: inline-block; padding: 5px; }
    .dev-list { display: none; margin-top: 5px; color: #888; font-style: italic; }

    .admin-link {
        display: inline-block; margin-top: 15px;
        color: #333; font-size: 11px; text-decoration: none;
        border: 1px solid #333; padding: 4px 10px; border-radius: 15px; transition: 0.3s;
    }
    .admin-link:hover { color: #fff; border-color: #fff; background: rgba(255,255,255,0.1); }
  </style>
</head>
<body>
  <div class="card">
    <h2>CLASS ATTENDANCE</h2>
    <form id="attForm">
      <select id="studentSelect" required>
        <option value="" disabled selected>-- Select Your Name --</option>
        %OPTIONS%
      </select>
      <button type="submit" class="btn-main">MARK PRESENT</button>
    </form>

    <div id="msg" style="margin-top:12px; font-size:13px; font-weight:bold;"></div>

    <div class="live-list">
        <div style="font-weight:bold; color:#00d2ff; margin-bottom:8px;">‚úÖ Today's Present List:</div>
        <div id="present-names">Loading...</div>
    </div>

    <button class="btn-sus" onclick="toggleSus()">‚ö†Ô∏è Check Suspicious Activity</button>
    
    <div id="sus-container">
        <div style="font-weight:bold; color:#ff4444; font-size:12px; margin-bottom:5px;">Devices used for multiple students:</div>
        <div id="sus-list">Checking...</div>
    </div>

    <button class="wall-btn" onclick="document.getElementById('bgInput').click()">üì∑ Change Wallpaper</button>
    <input type="file" id="bgInput" accept="image/*">

    <div class="dev-container">
        <span class="dev-btn" onclick="toggleDev()">Developed By</span>
        <div id="devPanel" class="dev-list">Ajeet Kumar & Reva</div>
    </div>

    <a href="/admin" class="admin-link">üîê Admin Login</a>
  </div>

  <script>
    const savedBg = localStorage.getItem('class_wall');
    if (savedBg) document.body.style.backgroundImage = `url(${savedBg})`;

    document.getElementById('bgInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(event) {
          try {
            localStorage.setItem('class_wall', event.target.result);
            document.body.style.backgroundImage = `url(${event.target.result})`;
          } catch(err) { alert("File too large. Try a smaller image."); }
        };
        reader.readAsDataURL(file);
      }
    });

    function toggleDev() {
      var x = document.getElementById("devPanel");
      x.style.display = (x.style.display === "block") ? "none" : "block";
    }

    function toggleSus() {
        var x = document.getElementById("sus-container");
        if(x.style.display === "block") {
            x.style.display = "none";
        } else {
            x.style.display = "block";
            loadSuspicious();
        }
    }

    function loadSuspicious() {
        fetch('/suspicious').then(res => res.json()).then(data => {
            let html = "";
            if(data.length === 0) html = "<span style='color:#888'>No suspicious activity.</span>";
            else data.forEach(n => { html += `<div>‚ùó ${n}</div>`; });
            document.getElementById('sus-list').innerHTML = html;
        });
    }

    function updateList() {
      fetch('/present').then(res => res.json()).then(data => {
        let html = "";
        if(data.length === 0) html = "<span style='color:#666'>No one yet...</span>";
        data.forEach(n => { html += `<div class='p-item'>‚ö° ${n}</div>`; });
        document.getElementById('present-names').innerHTML = html;
      });
    }
    updateList();

    document.getElementById('attForm').onsubmit = function(e) {
      e.preventDefault();
      let sel = document.getElementById('studentSelect');
      let val = sel.value;
      if(!val) return;
      
      document.getElementById('msg').innerHTML = "Wait...";
      let time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); 
      
      fetch('/mark?name=' + encodeURIComponent(val) + '&time=' + encodeURIComponent(time))
      .then(res => res.text()).then(text => {
        document.getElementById('msg').innerHTML = text;
        document.getElementById('msg').style.color = text.includes("Success") ? "#00ff88" : "#ff4444";
        if(text.includes("Success")) {
          updateList();
          sel.selectedIndex = 0;
          if(document.getElementById("sus-container").style.display === "block") loadSuspicious();
        }
      });
    };
  </script>
</body>
</html>